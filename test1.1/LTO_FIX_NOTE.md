# LTO ç¼–è¯‘é—®é¢˜ä¿®å¤è¯´æ˜

## ğŸ”´ é—®é¢˜æè¿°

åœ¨ä½¿ç”¨ `run_tests.sh` è„šæœ¬æ—¶ï¼Œå³ä½¿ä½¿ç”¨äº†åˆ†æ­¥ç¼–è¯‘ï¼ˆ`-c` é€‰é¡¹ï¼‰ï¼Œä»ç„¶å‡ºç°ç¼–è¯‘é”™è¯¯ï¼š

```
/usr/bin/ld: /tmp/ccjVMrOW.o (symbol from plugin): in function `print_hash':
(.text+0x0): multiple definition of `main'; aes_sm3_integrity.o (symbol from plugin):(.text+0x0): first defined here
collect2: error: ld returned 1 exit status
```

## ğŸ” æ ¹æœ¬åŸå› 

å…³é”®æ ‡è¯†ï¼š`(symbol from plugin)`

è¿™ä¸ªé”™è¯¯ä¿¡æ¯ä¸­çš„ **`(symbol from plugin)`** è¡¨æ˜é—®é¢˜æ¥è‡ª **LTOï¼ˆLink Time Optimizationï¼Œé“¾æ¥æ—¶ä¼˜åŒ–ï¼‰**ã€‚

### ä»€ä¹ˆæ˜¯ LTOï¼Ÿ

- LTO æ˜¯ä¸€ç§é«˜çº§ç¼–è¯‘ä¼˜åŒ–æŠ€æœ¯
- ä½¿ç”¨ `-flto` é€‰é¡¹å¯ç”¨
- åœ¨é“¾æ¥é˜¶æ®µè¿›è¡Œå…¨ç¨‹åºä¼˜åŒ–
- é€šå¸¸å¯ä»¥æå‡ 5-10% çš„æ€§èƒ½

### ä¸ºä»€ä¹ˆ LTO ä¼šå¯¼è‡´é—®é¢˜ï¼Ÿ

å½“é¡¹ç›®ä¸­æœ‰**å¤šä¸ª `main` å‡½æ•°**æ—¶ï¼š

1. **æ­£å¸¸æƒ…å†µ**ï¼šä½¿ç”¨ `-c` ç¼–è¯‘ç¬¬ä¸€ä¸ªæ–‡ä»¶ï¼Œä¸ä¼šæš´éœ² `main` ç¬¦å·ç»™é“¾æ¥å™¨
2. **LTO æƒ…å†µ**ï¼šå³ä½¿ä½¿ç”¨ `-c`ï¼ŒLTO æ’ä»¶ä»ä¼šåœ¨é“¾æ¥æ—¶åˆ†ææ‰€æœ‰ç¬¦å·ï¼Œå¯¼è‡´å‘ç°å¤šä¸ª `main` å‡½æ•°

æœ¬é¡¹ç›®æœ‰ä¸¤ä¸ª `main` å‡½æ•°ï¼š
- `aes_sm3_integrity.c` ä¸­çš„ `main()` - æ€§èƒ½æµ‹è¯•
- `test_aes_sm3_integrity.c` ä¸­çš„ `main()` - ç»¼åˆæµ‹è¯•

## âœ… è§£å†³æ–¹æ¡ˆ

### ç§»é™¤ `-flto` é€‰é¡¹

**ä¿®æ”¹å‰ï¼š**
```bash
COMPILE_FLAGS="-march=armv8.2-a+crypto -O3 -funroll-loops -ftree-vectorize \
               -finline-functions -ffast-math -flto -fomit-frame-pointer -pthread"
                                            ^^^^^ å¯¼è‡´é—®é¢˜
```

**ä¿®æ”¹åï¼š**
```bash
COMPILE_FLAGS="-march=armv8.2-a+crypto -O3 -funroll-loops -ftree-vectorize \
               -finline-functions -ffast-math -fomit-frame-pointer -pthread"
                                            # ç§»é™¤äº† -flto
```

## ğŸ“Š æ€§èƒ½å½±å“åˆ†æ

### LTO çš„æ€§èƒ½è´¡çŒ®

| ä¼˜åŒ–æŠ€æœ¯ | æ€§èƒ½æå‡ | æ˜¯å¦å¯ç”¨ |
|---------|---------|---------|
| `-O3` | 50-100% | âœ… å¯ç”¨ |
| `-funroll-loops` | 10-20% | âœ… å¯ç”¨ |
| `-ftree-vectorize` | 15-30% | âœ… å¯ç”¨ |
| `-finline-functions` | 5-15% | âœ… å¯ç”¨ |
| `-ffast-math` | 5-10% | âœ… å¯ç”¨ |
| `-flto` | 5-10% | âŒ **ä¸å¯ç”¨ï¼ˆç¬¦å·å†²çªï¼‰** |
| `-fomit-frame-pointer` | 2-5% | âœ… å¯ç”¨ |
| ARM ç¡¬ä»¶åŠ é€Ÿ | 10-20x | âœ… å¯ç”¨ |

### ç»“è®º

- **æŸå¤±**ï¼šçº¦ 5-10% çš„æ½œåœ¨æ€§èƒ½æå‡
- **æ”¶ç›Š**ï¼šç¼–è¯‘æˆåŠŸï¼Œå¯ä»¥æ­£å¸¸è¿è¡Œæµ‹è¯•
- **æ€»ä½“å½±å“**ï¼šå¾®ä¹å…¶å¾®ï¼Œå…¶ä»–ä¼˜åŒ–å·²ç»æä¾›äº†è¶³å¤Ÿçš„æ€§èƒ½

åœ¨æœ‰ ARM ç¡¬ä»¶åŠ é€Ÿï¼ˆ10-20å€æå‡ï¼‰çš„æƒ…å†µä¸‹ï¼ŒLTO çš„ 5-10% æå‡å‡ ä¹å¯ä»¥å¿½ç•¥ä¸è®¡ã€‚

## ğŸ”§ å·²ä¿®å¤çš„æ–‡ä»¶

1. âœ… `run_tests.sh` - è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬ï¼ˆLinux/Unixï¼‰
2. âœ… `compile.sh` - å¿«é€Ÿç¼–è¯‘è„šæœ¬ï¼ˆLinux/Unixï¼‰
3. âœ… `COMPILE_GUIDE.md` - ç¼–è¯‘æŒ‡å—æ–‡æ¡£
4. âœ… `TEST_README.md` - æµ‹è¯•æ–‡æ¡£
5. âœ… `QUICK_FIX.md` - å¿«é€Ÿä¿®å¤æŒ‡å—

## ğŸš€ ç°åœ¨å¯ä»¥æ­£å¸¸ä½¿ç”¨

```bash
# ç›´æ¥è¿è¡Œä¿®å¤åçš„è„šæœ¬
./run_tests.sh

# æˆ–ä½¿ç”¨å¿«é€Ÿç¼–è¯‘è„šæœ¬
./compile.sh
./test_aes_sm3

# æˆ–æ‰‹åŠ¨ç¼–è¯‘ï¼ˆä¸å¸¦ -fltoï¼‰
gcc -march=armv8.2-a+crypto -O3 -funroll-loops -ftree-vectorize \
    -finline-functions -ffast-math -fomit-frame-pointer -pthread \
    -c aes_sm3_integrity.c -o aes_sm3_integrity.o

gcc -march=armv8.2-a+crypto -O3 -funroll-loops -ftree-vectorize \
    -finline-functions -ffast-math -fomit-frame-pointer -pthread \
    -o test_aes_sm3 aes_sm3_integrity.o test_aes_sm3_integrity.c -lm

./test_aes_sm3
```

## ğŸ“ æŠ€æœ¯ç»†èŠ‚

### ä¸ºä»€ä¹ˆä¸èƒ½ç”¨ LTOï¼Ÿ

LTO çš„å·¥ä½œåŸç†ï¼š

```
æºä»£ç  (.c)
    â†“ gcc -flto -c
ä¸­é—´è¡¨ç¤º (.o with LTO IR)
    â†“ æ”¶é›†æ‰€æœ‰ .o æ–‡ä»¶
    â†“ LTO æ’ä»¶åˆ†æ
å…¨å±€ä¼˜åŒ–ï¼ˆåœ¨è¿™é‡Œå‘ç°å¤šä¸ª mainï¼ï¼‰
    â†“
é“¾æ¥é”™è¯¯
```

### æ›¿ä»£æ–¹æ¡ˆ

å¦‚æœçœŸçš„éœ€è¦ LTO çº§åˆ«çš„ä¼˜åŒ–ï¼š

1. **æ–¹æ¡ˆ A**ï¼šå°†ä¸¤ä¸ª `main` å‡½æ•°åˆ†ç¦»åˆ°ä¸åŒçš„å¯æ‰§è¡Œæ–‡ä»¶
   ```bash
   # ç¼–è¯‘æ€§èƒ½æµ‹è¯•ç‰ˆæœ¬
   gcc -O3 -flto -o perf_test aes_sm3_integrity.c -lm
   
   # ç¼–è¯‘æµ‹è¯•å¥—ä»¶ç‰ˆæœ¬ï¼ˆä¸èƒ½å’Œä¸Šé¢åŒæ—¶ç¼–è¯‘ï¼‰
   gcc -O3 -flto -c aes_sm3_integrity.c -o lib.o
   gcc -O3 -flto -o test_suite lib.o test_aes_sm3_integrity.c -lm
   ```
   ä½†è¿™æ ·éœ€è¦ä¿®æ”¹æ„å»ºç³»ç»Ÿã€‚

2. **æ–¹æ¡ˆ B**ï¼šä» `aes_sm3_integrity.c` ä¸­ç§»é™¤ `main` å‡½æ•°
   - å°† `main` ç§»åˆ°å•ç‹¬çš„ `main_perf.c` æ–‡ä»¶
   - `aes_sm3_integrity.c` åªåŒ…å«ç®—æ³•å®ç°
   
   ä½†è¿™æ ·ä¼šæ”¹å˜é¡¹ç›®ç»“æ„ã€‚

3. **æ–¹æ¡ˆ Cï¼ˆå½“å‰é€‰æ‹©ï¼‰**ï¼šç¦ç”¨ LTO
   - æœ€ç®€å•ã€æœ€ä¸ç ´åæ€§çš„æ–¹æ¡ˆ
   - æ€§èƒ½æŸå¤±å¯ä»¥æ¥å—
   - ä¸éœ€è¦æ”¹åŠ¨ä»£ç ç»“æ„

## âœ… éªŒè¯ä¿®å¤

è¿è¡Œè„šæœ¬ï¼Œåº”è¯¥çœ‹åˆ°ï¼š

```bash
$ ./run_tests.sh

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  AES-SM3å®Œæ•´æ€§æ ¡éªŒç®—æ³• - æµ‹è¯•ç¼–è¯‘å’Œè¿è¡Œè„šæœ¬
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ“ GCC ç‰ˆæœ¬: gcc (Ubuntu 9.4.0) 9.4.0
...
æ­¥éª¤1: ç¼–è¯‘ä¸»ç®—æ³•æ–‡ä»¶ä¸ºç›®æ ‡æ–‡ä»¶...
âœ“ ä¸»ç®—æ³•æ–‡ä»¶ç¼–è¯‘æˆåŠŸï¼ˆARMv8.2-Aä¼˜åŒ–ï¼‰

æ­¥éª¤2: ç¼–è¯‘æµ‹è¯•æ–‡ä»¶å¹¶é“¾æ¥...
âœ“ æµ‹è¯•ç¨‹åºé“¾æ¥æˆåŠŸï¼

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  æ­¥éª¤2: è¿è¡Œæµ‹è¯•å¥—ä»¶
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘       AES-SM3å®Œæ•´æ€§æ ¡éªŒç®—æ³• - ç»¼åˆæµ‹è¯•å¥—ä»¶               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
...
âœ“ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼
```

## ğŸ“š ç›¸å…³èµ„æ–™

- [GCC LTO æ–‡æ¡£](https://gcc.gnu.org/onlinedocs/gcc/Optimize-Options.html#index-flto)
- [é“¾æ¥æ—¶ä¼˜åŒ–åŸç†](https://en.wikipedia.org/wiki/Interprocedural_optimization)
- é¡¹ç›®å¿«é€Ÿä¿®å¤æŒ‡å—ï¼š`QUICK_FIX.md`
- è¯¦ç»†ç¼–è¯‘æŒ‡å—ï¼š`COMPILE_GUIDE.md`

---

**é—®é¢˜å·²è§£å†³ï¼** ğŸ‰

